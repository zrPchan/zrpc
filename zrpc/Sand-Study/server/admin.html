<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Push 管理 - Sand Study</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:16px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f5f5f5}
    code{word-break:break-all}
    .actions button{margin-right:6px}
  </style>
</head>
<body>
  <h1>Push サブスクリプション 管理</h1>
  <div>
    <button id="refresh">一覧を更新</button>
    <button id="sendAll">全員にテスト送信</button>
  </div>
  <div id="status" class="mt-8 text-muted"></div>
  <table id="list" class="mt-12">
    <thead><tr><th>#</th><th>endpoint</th><th>actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    async function load(){
      const r = await fetch('/api/subscriptions');
      const el = document.getElementById('status');
      if(!r.ok){ el.textContent = '一覧取得に失敗: ' + r.status; return; }
      const data = await r.json();
      const tbody = document.querySelector('#list tbody'); tbody.innerHTML = '';
      data.forEach((s, i) => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = String(i+1);
        const td2 = document.createElement('td'); td2.innerHTML = `<code>${s.endpoint}</code>`;
        const td3 = document.createElement('td'); td3.className = 'actions';
        const sendBtn = document.createElement('button'); sendBtn.textContent = '送信'; sendBtn.onclick = ()=> sendTo(s);
        const delBtn = document.createElement('button'); delBtn.textContent = '削除'; delBtn.onclick = ()=> delSub(s);
        td3.appendChild(sendBtn); td3.appendChild(delBtn);
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
        tbody.appendChild(tr);
      });
      el.textContent = `登録数: ${data.length}`;
    }
    async function sendTo(sub){
      const p = { title:'テスト通知', body:'管理画面からのテストです' };
      const r = await fetch('/api/send-to', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ subscription: sub, payload: p })});
      alert('送信: ' + (r.ok? 'OK':'失敗')); load();
    }
    async function delSub(sub){
      if(!confirm('削除しますか？')) return;
      const r = await fetch('/api/subscription', {method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify(sub)});
      alert('削除: ' + (r.ok? 'OK':'失敗')); load();
    }
    document.getElementById('refresh').addEventListener('click', load);
    document.getElementById('sendAll').addEventListener('click', async ()=>{
      const p = { title:'全体テスト', body:'全員へテスト送信' };
      const r = await fetch('/api/send', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(p)});
      alert('送信: ' + (r.ok? 'OK':'失敗'));
    });
    load();
  </script>
</body>
</html>
