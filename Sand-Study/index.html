<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- PWA / mobile meta -->
  <meta name="theme-color" content="#ffffff">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Sand Study">
  <link rel="manifest" href="manifest.json">
  <!-- iOS startup images (splash) - placeholder SVGs included in icons/ -->
  <!-- Replace with proper PNG exports for production for best compatibility. -->
  <link rel="apple-touch-startup-image" href="icons/splash-1125x2436.svg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1242x2688.svg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-828x1792.svg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-750x1334.svg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-640x1136.svg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1536x2048.svg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-2048x2732.svg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <!-- PNG preferred for broad compatibility, SVG fallback retained -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="apple-touch-icon.svg" type="image/svg+xml">
  <title>Sand Study</title>
  <!-- Cute rounded display font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Shared site styles and top-actions/modal styles -->
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="container">
  <!-- Top-right actions (ãƒ­ã‚°ã‚¤ãƒ³ / è¨­å®š) - injected so top-page login is available when serving Sand-Study -->
  <div class="top-actions">
    <a id="topBtnSettings" class="button" href="#">è¨­å®š</a>
    <a id="topBtnSignIn" class="button" href="#">ãƒ­ã‚°ã‚¤ãƒ³</a>
  </div>
  <!-- Update banner: shown when a new app version / service worker is available -->
  <div id="updateBanner" role="status" aria-live="polite">
    <div class="msg">æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚</div>
    <div class="actions">
      <button id="updateLaterBtn" type="button">ã‚ã¨ã§</button>
      <button id="updateNowBtn" type="button" class="primary">æ›´æ–°ã™ã‚‹</button>
    </div>
  </div>
  <!-- Quick manual update control: allows users to check for updates without reinstalling the PWA -->
  <div class="update-controls">
    <button id="checkUpdateBtn" type="button" class="btn-ghost">æ›´æ–°ã‚’ç¢ºèª</button>
  </div>
  <main>
    <!-- over-time alert banner -->
  <div id="overtimeAlert" role="status" aria-live="assertive">5åˆ†ã‚’è¶…ãˆã¾ã—ãŸ â€” ä¼‘æ†©ã‚„è¨˜éŒ²ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚ <button id="dismissAlertBtn" type="button">é–‰ã˜ã‚‹</button></div>
    <div class="stats">
      <div class="stat big"><span id="todayBottles">0</span> æœ¬ï¼ˆä»Šæ—¥ï¼‰</div>
      <div class="stat mid">ç´¯è¨ˆ <span id="cumBottles">0</span> æœ¬</div>
      <div class="stat small">Lv <span id="level">0</span></div>
    </div>
    <!-- Inline reset confirmation (embedded popup-like, not browser dialog) -->
  <div id="resetConfirmOverlay" class="overlay" aria-hidden="true">
      <div class="popup-box" role="dialog" aria-modal="true" aria-label="ãƒªã‚»ãƒƒãƒˆç¢ºèª">
        <div class="popup-body">
          <div class="popup-title">ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</div>
          <div class="popup-actions">
            <button id="resetConfirmYes" type="button" class="btn-primary">ã¯ã„</button>
            <button id="resetConfirmNo" type="button">ã„ã„ãˆ</button>
          </div>
        </div>
      </div>
    </div>
    <div class="bottle" role="img" aria-label="ç“¶ã®ç ‚ã®é‡">
      <div class="sand" id="sand"></div>
      <div class="rim"></div>
    </div>
    <div class="timer" aria-hidden="false">
      <div>çµŒéæ™‚é–“</div>
      <div id="timerDisplay">00:00</div>
    </div>
    <!-- Circular countdown UI -->
  <div class="countdown-ui">
      <div class="circle-wrap" aria-hidden="false">
        <svg class="countdown-ring" viewBox="0 0 192 192" width="160" height="160">
          <circle cx="96" cy="96" r="88" class="ring-bg" stroke-width="8" fill="none"/>
          <circle id="progressRing" cx="96" cy="96" r="88" class="ring-fg" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="553.0" stroke-dashoffset="0"/>
        </svg>
        <div class="circle-center">
          <div id="countdownDisplay" class="countdown-text">05:00</div>
          <div class="countdown-sub">/ 5åˆ†</div>
        </div>
      </div>
    </div>
    <div class="controls">
      <button id="startBtn" type="button">é–‹å§‹</button>
      <button id="toggleRunBtn" type="button">ä¸€æ™‚åœæ­¢</button>
  <button id="resetSessionBtn" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="endBtn" type="button">çµ‚äº†</button>
    </div>
    
    <!-- Target time selector: free users limited to 5 minutes, Pro users can set longer -->
    <div class="target-row">
      <label for="targetMinutesInput">ç›®æ¨™æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
      <input id="targetMinutesInput" type="number" min="1" max="240" step="1" value="5" />
      <button id="favOpenBtn" type="button" title="ãŠæ°—ã«å…¥ã‚Šã‚’ç®¡ç†" aria-haspopup="dialog">â˜…</button>
      <button id="themeOpenBtn" type="button" title="ãƒ†ãƒ¼ãƒã‚’å¤‰æ›´" aria-haspopup="dialog">ğŸ¨</button>
      <button id="upgradeBtn" type="button">Go Pro</button>
      <div id="proBadge">Free</div>
    </div>
    <!-- Favorites popup (hidden by default) wrapped in an overlay to behave like a modal -->
    <div id="favoritesOverlay" class="overlay" aria-hidden="true">
      <div id="favoritesPopup" class="favorites-popup" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="fav-header">ãŠæ°—ã«å…¥ã‚Š</div>
        <div class="fav-body">
          <div class="fav-add">
            <input id="favMinutesInput" type="number" min="1" max="240" placeholder="åˆ†ã‚’å…¥åŠ›" />
            <button id="favAddBtn" type="button">è¿½åŠ </button>
          </div>
          <div class="fav-list" id="favList" aria-live="polite"></div>
        </div>
        <div class="fav-actions"><button id="favCloseBtn" type="button">é–‰ã˜ã‚‹</button></div>
      </div>
      </div>

      <!-- Theme picker overlay -->
    <div id="themeOverlay" class="overlay" aria-hidden="true">
        <div id="themePopup" class="theme-popup" role="dialog" aria-modal="true" aria-hidden="true">
          <div class="fav-header">ãƒ†ãƒ¼ãƒã‚’é¸æŠ</div>
          <div class="fav-body">
            <div class="theme-columns">
              <div>
                <div class="fav-subheader">ç ‚ã®è‰²ï¼ˆSandï¼‰</div>
                <div id="themeGrid" class="theme-grid" aria-live="polite"></div>
              </div>
              <div>
                <div class="fav-subheader">èƒŒæ™¯è‰²ï¼ˆBackgroundï¼‰</div>
                <div id="bgThemeGrid" class="theme-grid" aria-live="polite"></div>
              </div>
            </div>
          </div>
          <div class="fav-actions"><button id="themeCloseBtn" type="button">é–‰ã˜ã‚‹</button></div>
        </div>
      </div>
    <!-- Auto-save settings: allow user to choose interval or turn off. -->
  <div id="autoSaveControls" class="text-center mt-8">
      <label for="autoSaveSelect">è‡ªå‹•ä¿å­˜:</label>
      <select id="autoSaveSelect">
        <option value="0">ã‚ªãƒ•</option>
        <option value="30">30 ç§’</option>
        <option value="60" selected>60 ç§’ï¼ˆæ¨å¥¨ï¼‰</option>
        <option value="120">90 ç§’</option>
      </select>
    </div>
    <!-- Persistent Push controls removed: Push registration is now attempted automatically on é–‹å§‹ -->
  </main>

  <!-- Learning logs (stacked at bottom) -->
  <section id="logs" aria-label="å­¦ç¿’ãƒ­ã‚°">
  <h4>å­¦ç¿’ãƒ­ã‚°ï¼ˆä»Šæ—¥ï¼‰</h4>
    <div class="log-list-outer">
      <div id="logList" class="log-list" aria-live="polite"></div>
    </div>
  </section>

  <div class="text-center mt-10">
    <a href="history.html" class="btn-outline" aria-label="å±¥æ­´ã¨åˆ†æãƒšãƒ¼ã‚¸ã¸">å±¥æ­´ã¨åˆ†æãƒšãƒ¼ã‚¸ã¸ â†’</a>
  </div>

  <!-- Debug controls for adjusting sand/bottles -->
  <section id="debugPanel" aria-label="ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«">
    <details class="debug-toggle">
      <summary class="debug-summary">
        <span class="debug-icon">ğŸ› ï¸</span>
        <span class="debug-title">ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«</span>
        <span class="debug-layer-badge" id="debugLayerBadge">Layer: 0</span>
      </summary>
      
      <div class="debug-content">
        <!-- Layer Controls -->
        <div class="debug-section">
          <div class="debug-section-title">ãƒ¬ã‚¤ãƒ¤ãƒ¼èª¿æ•´</div>
          <div class="debug-grid">
            <button id="inc1" type="button" class="debug-btn primary">+1 layer</button>
            <button id="inc10" type="button" class="debug-btn primary">+10 layer</button>
            <button id="dec1" type="button" class="debug-btn danger">-1 layer</button>
            <button id="set0" type="button" class="debug-btn warning">Reset layer</button>
          </div>
          <div class="debug-input-row">
            <input id="setLayerInput" type="number" placeholder="Layerå€¤ã‚’å…¥åŠ›" class="debug-input" />
            <button id="setLayerBtn" type="button" class="debug-btn">Set</button>
          </div>
        </div>
        
        <!-- Bottle Controls -->
        <div class="debug-section">
          <div class="debug-section-title">ãƒœãƒˆãƒ«èª¿æ•´</div>
          <div class="debug-grid-2">
            <button id="incBottle" type="button" class="debug-btn success">+1 bottle</button>
            <button id="decBottle" type="button" class="debug-btn danger">-1 bottle</button>
          </div>
        </div>
        
        <!-- System Controls -->
        <div class="debug-section">
          <div class="debug-section-title">ã‚·ã‚¹ãƒ†ãƒ </div>
          <div class="debug-grid">
            <button id="enableSEBtn" type="button" class="debug-btn">Enable SE</button>
            <button id="soundTestBtn" type="button" class="debug-btn">éŸ³ãƒ†ã‚¹ãƒˆ</button>
            <button id="notifyTestBtn" type="button" class="debug-btn">é€šçŸ¥ãƒ†ã‚¹ãƒˆ</button>
            <button id="iosHelpBtn" type="button" class="debug-btn">iOS æ‰‹é †</button>
          </div>
          <div class="debug-hint">é–‹ç™ºç”¨: ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿåˆ¶é™ã‚’å›é¿ã™ã‚‹ãŸã‚ã‚¯ãƒªãƒƒã‚¯ã§æœ‰åŠ¹åŒ–</div>
        </div>
        
        <!-- Push Controls -->
        <div class="debug-section">
          <div class="debug-section-title">Pushé€šçŸ¥</div>
          <div class="debug-grid-2">
            <button id="pushSubscribeBtn" type="button" class="debug-btn">Push ç™»éŒ²</button>
            <button id="pushUnsubscribeBtn" type="button" class="debug-btn danger">Push è§£é™¤</button>
          </div>
          <div class="debug-status">
            <div class="status-row">
              <span class="status-label">çŠ¶æ…‹:</span>
              <span id="pushStatus" class="status-value">æœªç¢ºèª</span>
            </div>
            <div class="status-row">
              <span class="status-label">VAPID:</span>
              <code id="vapidKey" class="status-code"></code>
            </div>
            <div class="status-row">
              <span class="status-label">Endpoint:</span>
              <code id="pushEndpoint" class="status-code"></code>
            </div>
          </div>
        </div>
      </div>
    </details>
  </section>

  <dialog id="iosHelpDialog">
    <form method="dialog" class="form-dialog">
      <h3>iOS ã§ Push ã‚’æœ‰åŠ¹ã«ã™ã‚‹æ‰‹é †</h3>
      <ol>
        <li>Safari ã§ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã™ã€‚<em>ï¼ˆhttps çµŒç”±ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰</em></li>
        <li>å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆä¸‹ã®å››è§’ã¨ä¸Šå‘ãçŸ¢å°ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚</li>
        <li>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸ã³ã¾ã™ã€‚</li>
        <li>ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰è¿½åŠ ã—ãŸã‚¢ã‚¤ã‚³ãƒ³ã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚</li>
        <li>ã‚¢ãƒ—ãƒªã‹ã‚‰ã€ŒPush ç™»éŒ²ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¨±å¯ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚</li>
      </ol>
      <p>è£œè¶³: iOS 16.4 ä»¥ä¸Šã§ PWA ã® Push ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚ºãƒ¢ãƒ¼ãƒ‰ã‚„å¤ã„ iOS ã§ã¯å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
  <div class="actions-right"><button id="iosHelpClose" type="button">é–‰ã˜ã‚‹</button></div>
    </form>
  </dialog>
  <!-- Login modal (ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸å°‚ç”¨) - shared with root index.html -->
  <div id="loginModal" class="modal-overlay" aria-hidden="true">
    <div class="modal">
      <h3>ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h3>
      <div class="modal-body">
        <label>ãƒ¡ãƒ¼ãƒ«<input id="topAuthEmail" type="email" placeholder="you@example.com"></label>
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰<input id="topAuthPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"></label>
        <div class="modal-actions">
          <button id="topBtnLogin" class="button">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
          <button id="topBtnRegister" class="button top-btn-register">æ–°è¦ç™»éŒ²</button>
          <button id="topBtnClose" class="button top-btn-close">é–‰ã˜ã‚‹</button>
        </div>
        <p id="topLoginStatus" class="top-login-status">æœªæ¥ç¶š</p>
      </div>
    </div>
  </div>
  <script src="../assets/js/main.js"></script>
  <script>
    // Fallback modal behavior: in case ../assets/js/main.js is not loaded,
    // ensure the login modal can still be opened/closed from Sand-Study page.
    (function(){
      function $id(id){ return document.getElementById(id); }
      const modal = $id('loginModal');
      const btn = $id('topBtnSignIn');
      const btnClose = $id('topBtnClose');
      if(!modal) return;
      function showModal(){ modal.setAttribute('aria-hidden','false'); modal.style.display='flex'; }
      function hideModal(){ modal.setAttribute('aria-hidden','true'); modal.style.display='none'; }
      // Initialize hidden state
      if(modal.getAttribute('aria-hidden') !== 'false') modal.style.display = 'none';
      if(btn) btn.addEventListener('click', function(e){ e.preventDefault(); showModal(); });
      if(btnClose) btnClose.addEventListener('click', function(e){ e.preventDefault(); hideModal(); });
      // Close when clicking the overlay background
      modal.addEventListener('click', function(e){ if(e.target === modal) hideModal(); });
      // Close on Escape
      document.addEventListener('keydown', function(e){ if(e.key === 'Escape') hideModal(); });
    })();
  </script>

  <dialog id="endModal">
    <form method="dialog" id="endForm">
      <label>æ°—åˆ† (mood)
        <select id="mood">
          <option value="2">2ï¼ˆã¨ã¦ã‚‚è‰¯ã„ï¼‰</option>
          <option value="1">1</option>
          <option value="0" selected>0ï¼ˆæ™®é€šï¼‰</option>
          <option value="-1">-1</option>
          <option value="-2">-2ï¼ˆã¨ã¦ã‚‚æ‚ªã„ï¼‰</option>
        </select>
      </label>
      <label>åŠªåŠ›æ„Ÿ (effort)
        <select id="effort">
          <option value="5">5ï¼ˆé«˜ï¼‰</option>
          <option value="4">4</option>
          <option value="3" selected>3ï¼ˆä¸­ï¼‰</option>
          <option value="2">2</option>
          <option value="1">1ï¼ˆä½ï¼‰</option>
        </select>
      </label>
      <label>ã‚¿ã‚¹ã‚¯å
        <input id="taskname" maxlength="50">
        <div class="char-counter" id="tasknameCount">50</div>
      </label>
      <label>æ°—ã¥ã
        <input id="insight" maxlength="50">
        <div class="char-counter" id="insightCount">50</div>
      </label>
      <label>æ¬¡ã®ã‚¿ã‚¹ã‚¯
        <input id="nexttask" maxlength="50">
        <div class="char-counter" id="nexttaskCount">50</div>
      </label>
      <!-- truncate warning (hidden by default) -->
      <div id="truncateWarning" class="truncate-warning">
        <div id="truncateText">ã‚³ãƒ¡ãƒ³ãƒˆãŒé•·ã™ãã‚‹ãŸã‚ã€ä¸€éƒ¨ã‚’åˆ‡ã‚Šè©°ã‚ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
        <div class="actions">
          <button id="truncateCancel" type="button">ç·¨é›†ã«æˆ»ã‚‹</button>
          <button id="truncateConfirm" type="button">åˆ‡ã‚Šè©°ã‚ã¦ä¿å­˜</button>
        </div>
      </div>
      <div class="row">
        <button id="saveBtn" type="button">ä¿å­˜</button>
        <button id="cancelBtn" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
      <div class="countdown" id="countdown">30</div>
    </form>
  </dialog>
  </div>

  <script type="module" src="app.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      // register from root so scope covers the whole app (important for PWA/home-screen)
      navigator.serviceWorker.register('/service-worker.js', { scope: '/' }).catch(()=>{/* noop */});
    }
  </script>
</body>
</html>