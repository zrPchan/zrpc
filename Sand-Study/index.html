<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- PWA / mobile meta -->
  <meta name="theme-color" content="#ffffff">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Sand Study">
  <link rel="manifest" href="manifest.json">
  <!-- iOS startup images (splash) - placeholder SVGs included in icons/ -->
  <!-- Replace with proper PNG exports for production for best compatibility. -->
  <link rel="apple-touch-startup-image" href="icons/splash-1125x2436.svg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1242x2688.svg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-828x1792.svg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-750x1334.svg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-640x1136.svg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-1536x2048.svg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="icons/splash-2048x2732.svg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <!-- PNG preferred for broad compatibility, SVG fallback retained -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="apple-touch-icon.svg" type="image/svg+xml">
  <title>Sand Study</title>
  <!-- Cute rounded display font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Shared site styles and top-actions/modal styles -->
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="container">
  <!-- Top-right actions (ログイン / 設定) - injected so top-page login is available when serving Sand-Study -->
  <div class="top-actions">
    <a id="topBtnSettings" class="button" href="#">設定</a>
    <a id="topBtnSignIn" class="button" href="#">ログイン</a>
  </div>
  <!-- Update banner: shown when a new app version / service worker is available -->
  <div id="updateBanner" role="status" aria-live="polite">
    <div class="msg">新しいバージョンがあります。</div>
    <div class="actions">
      <button id="updateLaterBtn" type="button">あとで</button>
      <button id="updateNowBtn" type="button" class="primary">更新する</button>
    </div>
  </div>
  <!-- Quick manual update control: allows users to check for updates without reinstalling the PWA -->
  <div class="update-controls">
    <button id="checkUpdateBtn" type="button" class="btn-ghost">更新を確認</button>
  </div>
  <main>
    <!-- over-time alert banner -->
  <div id="overtimeAlert" role="status" aria-live="assertive">5分を超えました — 休憩や記録を検討してください。 <button id="dismissAlertBtn" type="button">閉じる</button></div>
    <div class="stats">
      <div class="stat big"><span id="todayBottles">0</span> 本（今日）</div>
      <div class="stat mid">累計 <span id="cumBottles">0</span> 本</div>
      <div class="stat small">Lv <span id="level">0</span></div>
    </div>
    <!-- Inline reset confirmation (embedded popup-like, not browser dialog) -->
  <div id="resetConfirmOverlay" class="overlay" aria-hidden="true">
      <div class="popup-box" role="dialog" aria-modal="true" aria-label="リセット確認">
        <div class="popup-body">
          <div class="popup-title">リセットしますか？</div>
          <div class="popup-actions">
            <button id="resetConfirmYes" type="button" class="btn-primary">はい</button>
            <button id="resetConfirmNo" type="button">いいえ</button>
          </div>
        </div>
      </div>
    </div>
    <div class="bottle" role="img" aria-label="瓶の砂の量">
      <div class="sand" id="sand"></div>
      <div class="rim"></div>
    </div>
    <div class="timer" aria-hidden="false">
      <div>経過時間</div>
      <div id="timerDisplay">00:00</div>
    </div>
    <!-- Circular countdown UI -->
  <div class="countdown-ui">
      <div class="circle-wrap" aria-hidden="false">
        <svg class="countdown-ring" viewBox="0 0 192 192" width="160" height="160">
          <circle cx="96" cy="96" r="88" class="ring-bg" stroke-width="8" fill="none"/>
          <circle id="progressRing" cx="96" cy="96" r="88" class="ring-fg" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="553.0" stroke-dashoffset="0"/>
        </svg>
        <div class="circle-center">
          <div id="countdownDisplay" class="countdown-text">05:00</div>
          <div class="countdown-sub">/ 5分</div>
        </div>
      </div>
    </div>
    <div class="controls">
      <button id="startBtn" type="button">開始</button>
      <button id="toggleRunBtn" type="button">一時停止</button>
  <button id="resetSessionBtn" type="button">リセット</button>
      <button id="endBtn" type="button">終了</button>
    </div>
    
    <!-- Target time selector: free users limited to 5 minutes, Pro users can set longer -->
    <div class="target-row">
      <label for="targetMinutesInput">目標時間（分）</label>
      <input id="targetMinutesInput" type="number" min="1" max="240" step="1" value="5" />
      <button id="favOpenBtn" type="button" title="お気に入りを管理" aria-haspopup="dialog">★</button>
      <button id="themeOpenBtn" type="button" title="テーマを変更" aria-haspopup="dialog">🎨</button>
      <button id="upgradeBtn" type="button">Go Pro</button>
      <div id="proBadge">Free</div>
    </div>
    <!-- Favorites popup (hidden by default) wrapped in an overlay to behave like a modal -->
    <div id="favoritesOverlay" class="overlay" aria-hidden="true">
      <div id="favoritesPopup" class="favorites-popup" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="fav-header">お気に入り</div>
        <div class="fav-body">
          <div class="fav-add">
            <input id="favMinutesInput" type="number" min="1" max="240" placeholder="分を入力" />
            <button id="favAddBtn" type="button">追加</button>
          </div>
          <div class="fav-list" id="favList" aria-live="polite"></div>
        </div>
        <div class="fav-actions"><button id="favCloseBtn" type="button">閉じる</button></div>
      </div>
      </div>

      <!-- Theme picker overlay -->
    <div id="themeOverlay" class="overlay" aria-hidden="true">
        <div id="themePopup" class="theme-popup" role="dialog" aria-modal="true" aria-hidden="true">
          <div class="fav-header">テーマを選択</div>
          <div class="fav-body">
            <div class="theme-columns">
              <div>
                <div class="fav-subheader">砂の色（Sand）</div>
                <div id="themeGrid" class="theme-grid" aria-live="polite"></div>
              </div>
              <div>
                <div class="fav-subheader">背景色（Background）</div>
                <div id="bgThemeGrid" class="theme-grid" aria-live="polite"></div>
                <div class="ring-color-row">
                  <label for="ringColorInput">タイマーリング色（個別）</label>
                  <div class="ring-color-controls">
                    <!-- Hidden native color input; we expose a themed button that opens this picker -->
                    <input id="ringColorInput" type="color" value="#4a8fe0" title="タイマーリング色を選択" style="display:none" />
                    <div id="ringColorCustomWrap">
                      <button id="ringColorCustomBtn" class="theme-swatch ring-custom" type="button" data-theme="custom" data-color="#4a8fe0" title="カスタム色を選択">
                        <span class="swatch-sample" style="background:hsl(33, 49%, 67%)"></span>
                        <div class="swatch-label">カスタム</div>
                      </button>
                      <button id="ringColorReset" type="button" class="btn-ghost">リセット</button>
                    </div>
                  </div>
                  <div id="ringColorPresets" class="ring-presets" aria-hidden="false"></div>
                  <div class="ring-color-note">ここで選んだ色は背景テーマに優先して保存されます。</div>
                </div>
              </div>
            </div>
          </div>
          <div class="fav-actions"><button id="themeCloseBtn" type="button">閉じる</button></div>
        </div>
      </div>
    <!-- Auto-save settings: allow user to choose interval or turn off. -->
  <div id="autoSaveControls" class="text-center mt-8">
      <label for="autoSaveSelect">自動保存:</label>
      <select id="autoSaveSelect">
        <option value="0">オフ</option>
        <option value="30">30 秒</option>
        <option value="60" selected>60 秒（推奨）</option>
        <option value="120">90 秒</option>
      </select>
    </div>
    <!-- Persistent Push controls removed: Push registration is now attempted automatically on 開始 -->
  </main>

  <!-- Learning logs (stacked at bottom) -->
  <section id="logs" aria-label="学習ログ">
  <h4>学習ログ（今日）</h4>
    <div class="log-list-outer">
      <div id="logList" class="log-list" aria-live="polite"></div>
    </div>
  </section>

  <div class="text-center mt-10">
    <a href="history.html" class="btn-outline" aria-label="履歴と分析ページへ">履歴と分析ページへ →</a>
  </div>

  <!-- Debug controls for adjusting sand/bottles -->
  <section id="debugPanel" aria-label="デバッグパネル">
    <details class="debug-toggle">
      <summary class="debug-summary">
        <span class="debug-icon">🛠️</span>
        <span class="debug-title">デバッグパネル</span>
        <span class="debug-layer-badge" id="debugLayerBadge">Layer: 0</span>
      </summary>
      
      <div class="debug-content">
        <!-- Layer Controls -->
        <div class="debug-section">
          <div class="debug-section-title">レイヤー調整</div>
          <div class="debug-grid">
            <button id="inc1" type="button" class="debug-btn primary">+1 layer</button>
            <button id="inc10" type="button" class="debug-btn primary">+10 layer</button>
            <button id="dec1" type="button" class="debug-btn danger">-1 layer</button>
            <button id="set0" type="button" class="debug-btn warning">Reset layer</button>
          </div>
          <div class="debug-input-row">
            <input id="setLayerInput" type="number" placeholder="Layer値を入力" class="debug-input" />
            <button id="setLayerBtn" type="button" class="debug-btn">Set</button>
          </div>
        </div>
        
        <!-- Bottle Controls -->
        <div class="debug-section">
          <div class="debug-section-title">ボトル調整</div>
          <div class="debug-grid-2">
            <button id="incBottle" type="button" class="debug-btn success">+1 bottle</button>
            <button id="decBottle" type="button" class="debug-btn danger">-1 bottle</button>
          </div>
        </div>
        
        <!-- System Controls -->
        <div class="debug-section">
          <div class="debug-section-title">システム</div>
          <div class="debug-grid">
            <button id="enableSEBtn" type="button" class="debug-btn">Enable SE</button>
            <button id="soundTestBtn" type="button" class="debug-btn">音テスト</button>
            <button id="notifyTestBtn" type="button" class="debug-btn">通知テスト</button>
            <button id="iosHelpBtn" type="button" class="debug-btn">iOS 手順</button>
          </div>
          <div class="debug-hint">開発用: ブラウザの自動再生制限を回避するためクリックで有効化</div>
        </div>
        
        <!-- Push Controls -->
        <div class="debug-section">
          <div class="debug-section-title">Push通知</div>
          <div class="debug-grid-2">
            <button id="pushSubscribeBtn" type="button" class="debug-btn">Push 登録</button>
            <button id="pushUnsubscribeBtn" type="button" class="debug-btn danger">Push 解除</button>
          </div>
          <div class="debug-status">
            <div class="status-row">
              <span class="status-label">状態:</span>
              <span id="pushStatus" class="status-value">未確認</span>
            </div>
            <div class="status-row">
              <span class="status-label">VAPID:</span>
              <code id="vapidKey" class="status-code"></code>
            </div>
            <div class="status-row">
              <span class="status-label">Endpoint:</span>
              <code id="pushEndpoint" class="status-code"></code>
            </div>
          </div>
        </div>
      </div>
    </details>
  </section>

  <dialog id="iosHelpDialog">
    <form method="dialog" class="form-dialog">
      <h3>iOS で Push を有効にする手順</h3>
      <ol>
        <li>Safari でこのページを開きます。<em>（https 経由であることを確認）</em></li>
        <li>共有ボタン（下の四角と上向き矢印）をタップします。</li>
        <li>メニューから「ホーム画面に追加」を選びます。</li>
        <li>ホーム画面から追加したアイコンでアプリを起動します。</li>
        <li>アプリから「Push 登録」をタップして許可を与えてください。</li>
      </ol>
      <p>補足: iOS 16.4 以上で PWA の Push がサポートされています。プライベートブラウズモードや古い iOS では動作しない可能性があります。</p>
  <div class="actions-right"><button id="iosHelpClose" type="button">閉じる</button></div>
    </form>
  </dialog>
  <!-- Login modal (トップページ専用) - shared with root index.html -->
  <div id="loginModal" class="modal-overlay" aria-hidden="true">
    <div class="modal">
      <h3>サインイン</h3>
      <div class="modal-body">
        <label>メール<input id="topAuthEmail" type="email" placeholder="you@example.com"></label>
        <label>パスワード<input id="topAuthPassword" type="password" placeholder="パスワード"></label>
        <div class="modal-actions">
          <button id="topBtnLogin" class="button">サインイン</button>
          <button id="topBtnRegister" class="button top-btn-register">新規登録</button>
          <button id="topBtnClose" class="button top-btn-close">閉じる</button>
        </div>
        <p id="topLoginStatus" class="top-login-status">未接続</p>
      </div>
    </div>
  </div>
  <script src="../assets/js/main.js"></script>
  <script>
    // Fallback modal behavior: in case ../assets/js/main.js is not loaded,
    // ensure the login modal can still be opened/closed from Sand-Study page.
    (function(){
      function $id(id){ return document.getElementById(id); }
      const modal = $id('loginModal');
      const btn = $id('topBtnSignIn');
      const btnClose = $id('topBtnClose');
      if(!modal) return;
      function showModal(){ modal.setAttribute('aria-hidden','false'); modal.style.display='flex'; }
      function hideModal(){ modal.setAttribute('aria-hidden','true'); modal.style.display='none'; }
      // Initialize hidden state
      if(modal.getAttribute('aria-hidden') !== 'false') modal.style.display = 'none';
      if(btn) btn.addEventListener('click', function(e){ e.preventDefault(); showModal(); });
      if(btnClose) btnClose.addEventListener('click', function(e){ e.preventDefault(); hideModal(); });
      // Close when clicking the overlay background
      modal.addEventListener('click', function(e){ if(e.target === modal) hideModal(); });
      // Close on Escape
      document.addEventListener('keydown', function(e){ if(e.key === 'Escape') hideModal(); });
    })();
  </script>

  <dialog id="endModal">
    <form method="dialog" id="endForm">
      <label>気分 (mood)
        <select id="mood">
          <option value="2">2（とても良い）</option>
          <option value="1">1</option>
          <option value="0" selected>0（普通）</option>
          <option value="-1">-1</option>
          <option value="-2">-2（とても悪い）</option>
        </select>
      </label>
      <label>努力感 (effort)
        <select id="effort">
          <option value="5">5（高）</option>
          <option value="4">4</option>
          <option value="3" selected>3（中）</option>
          <option value="2">2</option>
          <option value="1">1（低）</option>
        </select>
      </label>
      <label>タスク名
        <input id="taskname" maxlength="50">
        <div class="char-counter" id="tasknameCount">50</div>
      </label>
      <label>気づき
        <input id="insight" maxlength="50">
        <div class="char-counter" id="insightCount">50</div>
      </label>
      <label>次のタスク
        <input id="nexttask" maxlength="50">
        <div class="char-counter" id="nexttaskCount">50</div>
      </label>
      <!-- truncate warning (hidden by default) -->
      <div id="truncateWarning" class="truncate-warning">
        <div id="truncateText">コメントが長すぎるため、一部を切り詰めして保存します。続行しますか？</div>
        <div class="actions">
          <button id="truncateCancel" type="button">編集に戻る</button>
          <button id="truncateConfirm" type="button">切り詰めて保存</button>
        </div>
      </div>
      <div class="row">
        <button id="saveBtn" type="button">保存</button>
        <button id="cancelBtn" type="button">キャンセル</button>
      </div>
      <div class="countdown" id="countdown">30</div>
    </form>
  </dialog>
  </div>

  <!-- Initialize firebase early (loads compat SDKs + server config and sets auth persistence) -->
  <script src="/assets/js/firebase-init.js"></script>
  <script type="module" src="app.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      // register from root so scope covers the whole app (important for PWA/home-screen)
      navigator.serviceWorker.register('/service-worker.js', { scope: '/' }).catch(()=>{/* noop */});
    }
  </script>
</body>
</html>